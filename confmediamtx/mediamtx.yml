# MediaMTX Configuration File - OPTIMIZADO PARA ESTABILIDAD
# Configuración para streaming.cellcomweb.com.ar

###############################################
# General settings

logLevel: info
logDestinations: [stdout, file]
logFile: /var/log/mediamtx.log

# API HTTP server
api: yes
apiAddress: :9997

# Metrics
metrics: yes
metricsAddress: :9998

# PPROF (performance profiling)
pprof: no
pprofAddress: :9999

###############################################
# RTMP server (para OBS)

rtmp: yes
rtmpAddress: :1935
rtmpEncryption: "no"
rtmpServerKey: ""
rtmpServerCert: ""

###############################################
# RTSP server

rtsp: yes
rtspAddress: :8554
protocols: [tcp, udp]  # Eliminado multicast (raramente usado)
encryption: "no"

###############################################
# HLS server - CONFIGURACIÓN OPTIMIZADA

hls: yes
hlsAddress: :8889
hlsEncryption: yes
hlsServerKey: /www/server/panel/vhost/cert/streaming.cellcomweb.com.ar/privkey.pem
hlsServerCert: /www/server/panel/vhost/cert/streaming.cellcomweb.com.ar/fullchain.pem
hlsAllowOrigin: "*"
hlsTrustedProxies: []

# === CAMBIOS CRÍTICOS PARA ESTABILIDAD ===

# 1. Cambiar a lowLatency (IMPORTANTE)
hlsVariant: lowLatency   # Cambiado de mpegts a lowLatency

# 2. Segmentos más consistentes
hlsSegmentCount: 7       # Mantener 7 segmentos (ya funcionaba)
hlsSegmentDuration: 2s   # Cambiado de 1s a 2s (más estable)
hlsPartDuration: 200ms   # Para LL-HLS

# 3. Configuración de remux y tamaño
hlsSegmentMaxSize: 50M
hlsAlwaysRemux: no       # No remuxear (mejor performance)
hlsDirectory: ""         # RAM en lugar de disco

###############################################
# WebRTC server

webrtc: yes
webrtcAddress: :889      # Puerto diferente a HLS
webrtcEncryption: no
webrtcServerKey: ""
webrtcServerCert: ""
webrtcAllowOrigin: "*"
webrtcTrustedProxies: []
webrtcICEServers2: []

###############################################
# SRT server (opcional)

srt: no
srtAddress: :8890

###############################################
# Recording

record: no

###############################################
# Paths (rutas de streaming)

pathDefaults:
  # Source
  source: publisher
  sourceFingerprint: ""
  sourceOnDemand: no
  sourceOnDemandStartTimeout: 10s
  sourceOnDemandCloseAfter: 10s
  
  # Autenticación
  publishUser: ""
  publishPass: ""
  publishIPs: []
  
  # Reproducción
  readUser: ""
  readPass: ""
  readIPs: []
  
  # Parámetros de streaming
  runOnInit: ""
  runOnInitRestart: no
  runOnDemand: ""
  runOnDemandRestart: no
  runOnDemandStartTimeout: 10s
  runOnDemandCloseAfter: 10s
  runOnReady: ""
  runOnReadyRestart: no
  runOnNotReady: ""
  runOnRead: ""
  runOnReadRestart: no
  runOnUnread: ""
  
  # Grabación por defecto
  record: no
  recordPath: ./recordings/%path/%Y-%m-%d_%H-%M-%S-%f
  recordFormat: fmp4
  recordPartDuration: 1h
  recordSegmentDuration: 1h
  recordDeleteAfter: 24h

# Paths específicos
paths:
  # Path para /live/
  live:
    publishUser: ""
    publishPass: ""
    publishIPs: []
    
    readUser: ""
    readPass: ""
    readIPs: []
    
    # Grabación habilitada
    record: yes
    recordPath: /opt/mediamtx/recordings/%path/%Y-%m-%d_%H-%M-%S
    recordFormat: fmp4
    recordPartDuration: 2h
    recordSegmentDuration: 1h
    recordDeleteAfter: 168h  # 7 días
    
  # Path regex para cualquier stream key bajo /live/
  ~^live/(.+)$:
    publishUser: ""
    publishPass: ""
    readUser: ""
    readPass: ""
    
    record: yes
    recordPath: /opt/mediamtx/recordings/$1/%Y-%m-%d_%H-%M-%S
    recordFormat: fmp4
    recordPartDuration: 2h
    recordSegmentDuration: 1h
    recordDeleteAfter: 168h

###############################################
# Configuración de red - OPTIMIZADA

# Aumentar timeouts para conexiones más estables
readTimeout: 20s         # Aumentado de 10s a 20s
writeTimeout: 20s        # Aumentado de 10s a 20s
readBufferCount: 1024    # Aumentado de 512 a 1024 (más buffer)
udpMaxPayloadSize: 1472

###############################################
# CONFIGURACIÓN CRÍTICA PARA OBS

# ============================================
# CONFIGURACIÓN OBS REQUERIDA:
# ============================================
#
# Settings > Output > Streaming:
# - Encoder: x264 (o NVENC H.264 si tienes GPU Nvidia)
# - Rate Control: CBR (Constant Bitrate) ⭐ IMPORTANTE
# - Bitrate: 2500 kbps (NO más de 3500)
# - Keyframe Interval: 2 ⭐ CRÍTICO (debe coincidir con hlsSegmentDuration)
# - CPU Preset: veryfast (o faster si tu CPU lo soporta)
# - Profile: main
# - Tune: zerolatency
#
# Settings > Video:
# - Base Resolution: 1920x1080
# - Output Resolution: 1280x720 (recomendado para streaming estable)
# - FPS: 30 (no usar 60fps a menos que tengas excelente conexión)
#
# Settings > Advanced:
# - Process Priority: High
# - Network Buffering: unchecked
#
# ============================================

# RTMP URL para OBS:
# rtmp://streaming.cellcomweb.com.ar:1935/live

# Stream Key:
# sk_XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX

# HLS URL para reproducción:
# https://streaming.cellcomweb.com.ar:8889/live/sk_XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX/index.m3u8

# Ver streams activos:
# curl http://localhost:9997/v3/paths/list

# Ver métricas:
# curl http://localhost:9998/metrics

# Logs en tiempo real:
# tail -f /var/log/mediamtx.log